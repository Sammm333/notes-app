<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Notes App UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#4CAF50">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="page">
    <div class="left-title">
      <span class="emoji">üìù</span>
      <h1>Notes App UI</h1>
    </div>

    <div class="phone">
      <div class="phone-notch"></div>
      <div class="phone-inner">
        <!-- Top actions -->
        <div class="top-bar">
          <button id="installBtn" hidden class="icon-btn" title="Install">üì≤</button>
          <button id="themeToggle" class="icon-btn" aria-label="Toggle theme" title="Theme">üåô</button>
        </div>

        <!-- Add note form (no visible Add button; FAB handles add) -->
        <form method="POST" action="{{ url_for('add') }}" class="note-form" id="noteForm">
          <input type="text" name="note" placeholder="Enter note..." required class="note-input" id="noteInput">
          {% if notes|length > 0 %}
            <a href="{{ url_for('clear') }}" class="clear-all" onclick="return confirm('Clear all notes?');">Clear all</a>
          {% endif %}
          <!-- Hidden submit fallback for accessibility -->
          <button type="submit" hidden aria-hidden="true">Submit</button>
        </form>

        <!-- Search -->
        {% if notes|length > 0 %}
          <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="Search notes..." class="search-input" aria-label="Search notes">
            <button id="clearSearch" class="search-clear" hidden title="Clear">‚úñ</button>
          </div>
          <p id="searchCount" class="search-count"></p>
        {% endif %}

        <!-- Cards list -->
        <div class="cards" id="notesGrid">
          {% for note in notes %}
            <div class="card color-{{ loop.index % 5 }}">
              <p class="card-text" data-original="{{ note | e }}">{{ note }}</p>
              <a class="card-delete" href="{{ url_for('delete', index=loop.index0) }}" title="Delete">‚úñ</a>
            </div>
          {% endfor %}
          {% if notes|length == 0 %}
            <p class="empty">No notes yet. Add your first note above.</p>
          {% endif %}
        </div>

        <!-- Floating action button: plus icon -->
        <button id="fabAdd" class="fab" aria-label="Add note" title="Add note">+</button>
      </div>
    </div>
  </div>

  <script>
    // Service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/service-worker.js")
          .catch(err => console.error("SW registration failed:", err));
      });
    }

    // Theme toggle
    const themeBtn = document.getElementById("themeToggle");
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") document.body.classList.add("dark");
    themeBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
    themeBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
      themeBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
    });

    // PWA install
    let deferredPrompt;
    const installBtn = document.getElementById("installBtn");
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.hidden = false;
    });
    installBtn.addEventListener("click", async () => {
      installBtn.hidden = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      }
    });

    // Plus FAB: focus or submit
    const fabAdd = document.getElementById("fabAdd");
    const noteInput = document.getElementById("noteInput");
    const noteForm = document.getElementById("noteForm");
    fabAdd.addEventListener("click", () => {
      const value = (noteInput.value || "").trim();
      if (!value) {
        noteInput.focus();
        noteInput.classList.add("pulse");
        setTimeout(() => noteInput.classList.remove("pulse"), 350);
      } else {
        noteForm.requestSubmit(); // submits the form
      }
    });

    // Search with highlight + counter + clear
    const searchInput = document.getElementById("searchInput");
    const notesGrid = document.getElementById("notesGrid");
    const clearSearch = document.getElementById("clearSearch");
    const searchCount = document.getElementById("searchCount");

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.innerText = str;
      return div.innerHTML;
    }
    function highlight(text, query) {
      if (!query) return escapeHtml(text);
      const lowerText = text.toLowerCase();
      const lowerQuery = query.toLowerCase();
      const idx = lowerText.indexOf(lowerQuery);
      if (idx === -1) return escapeHtml(text);
      const before = escapeHtml(text.slice(0, idx));
      const match = escapeHtml(text.slice(idx, idx + query.length));
      const after = escapeHtml(text.slice(idx + query.length));
      return `${before}<span class="hl">${match}</span>${after}`;
    }
    function updateSearch() {
      const query = (searchInput?.value || "").trim().toLowerCase();
      const cards = notesGrid ? Array.from(notesGrid.getElementsByClassName("card")) : [];
      let matches = 0;
      cards.forEach(card => {
        const textEl = card.querySelector(".card-text");
        const original = textEl.getAttribute("data-original") || textEl.textContent;
        const isMatch = original.toLowerCase().includes(query);
        card.style.display = !query || isMatch ? "grid" : "none";
        textEl.innerHTML = highlight(original, query);
        if (!query || isMatch) matches++;
      });
      if (searchCount) searchCount.textContent = query ? `${matches} match${matches === 1 ? "" : "es"}` : "";
      if (clearSearch) clearSearch.hidden = !query;
    }
    if (searchInput) searchInput.addEventListener("input", updateSearch);
    if (clearSearch && searchInput) {
      clearSearch.addEventListener("click", () => {
        searchInput.value = "";
        updateSearch();
        searchInput.focus();
      });
    }
    updateSearch();
  </script>
</body>
</html>
